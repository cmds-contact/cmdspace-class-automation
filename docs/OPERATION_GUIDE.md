# PUBL 데이터 관리자 운영 가이드

이 문서는 비개발자도 이해할 수 있도록 작성된 운영 가이드입니다.

---

## 1. 이 자동화는 무엇을 하나요?

**한 문장 요약**: publ.biz에서 회원/주문/환불 데이터를 자동으로 가져와 Airtable에 정리해줍니다.

**비유**: 매일 출근해서 publ.biz 관리자 페이지를 열고, 엑셀 파일 3개를 다운로드하고, 그걸 Airtable에 붙여넣는 작업을 대신 해주는 비서입니다.

---

## 2. 전체 흐름 요약

```
[publ.biz 콘솔]
     |
     | 1. 로그인 (자동)
     | 2. CSV 파일 3개 다운로드
     |    - 회원 목록
     |    - 주문 목록
     |    - 환불 목록
     v
[downloads 폴더]
     |
     | 3. Airtable에 동기화
     |    - 신규 데이터만 추가
     |    - 중복 방지
     v
[Airtable]
     |
     | 4. 파일 아카이브
     v
[archive 폴더]
     |
     | 5. 실행 기록 저장
     v
[완료]
```

**소요 시간**: 1-2분

---

## 3. 입력과 출력

### 3.1 입력 (필요한 것)

| 항목 | 설명 | 위치 |
|------|------|------|
| publ.biz 계정 | 콘솔 로그인 이메일/비밀번호 | `.env` 파일 |
| Airtable API 키 | Airtable 접근 권한 | `.env` 파일 |
| Airtable Base ID | 어느 Base에 저장할지 | `.env` 파일 |

### 3.2 출력 (결과물)

| 항목 | 설명 | 위치 |
|------|------|------|
| Airtable 데이터 | 회원/주문/환불 테이블 | Airtable 웹사이트 |
| CSV 백업 | 다운로드한 원본 파일 | `archive/날짜/` 폴더 |
| 실행 로그 | 언제 무슨 일이 있었는지 | `logs/` 폴더 |
| 동기화 기록 | 성공/실패 여부 | Airtable SyncHistory 테이블 |

---

## 4. 일상적인 사용법

### 4.1 실행 방법

**방법 1: 더블클릭 (가장 쉬움)**
1. `run.command` 파일을 더블클릭
2. 터미널 창이 열리고 자동 실행
3. "완료" 메시지가 나올 때까지 대기 (1-2분)

**방법 2: 터미널에서 직접**
```bash
cd [프로젝트 폴더]
python -m src.main
```

### 4.2 실행 후 확인 사항

1. **터미널 창**: "완료 시간" 메시지 확인
2. **Airtable SyncHistory 테이블**:
   - Status가 "Success"인지 확인
   - Members New, Orders New 숫자 확인
3. **로그 파일**: `logs/sync_오늘날짜.log` 파일 확인

---

## 5. 위험 지역 (건드리면 안 되는 곳)

### 5.1 절대 변경 금지 파일

| 파일 | 이유 |
|------|------|
| `.env` | 비밀번호와 API 키 포함. 실수로 수정하면 로그인 불가 |
| `.session.json` | 로그인 세션 정보. 삭제하면 다시 로그인 필요 |
| `src/` 폴더 전체 | 코드 파일. 수정하면 동작 불가 |

### 5.2 Airtable 주의 필드 (절대 수정 금지)

| 테이블 | 필드 | 이유 |
|--------|------|------|
| Members | Member Code | 고유 식별자. 수정 시 중복 발생 |
| Orders | Order Number | 고유 식별자. 수정 시 중복 발생 |
| Products | Product Code | 상품 식별자. 연결 관계 깨짐 |
| MemberProducts | MemberProducts Code | 회원+상품 조합 키 |

### 5.3 수동 입력 필드 (운영자가 관리)

| 테이블 | 필드 | 설명 |
|--------|------|------|
| Products | Subscription Days | 구독 기간 (일). 상품 추가 시 수동 입력 |
| Products | Display Name | 표시용 상품명. 수동 입력 |
| MemberProducts | Welcome Sent | 안내 메일 발송 여부. 체크박스 |

### 5.4 삭제하면 안 되는 것들

- `archive/` 폴더: 백업 데이터
- `downloads/` 폴더: 진행 중인 데이터
- `logs/` 폴더: 문제 발생 시 원인 추적용

---

## 6. 문제 해결 가이드

### 6.1 "로그인 실패" 오류

**증상**: `로그인 오류` 또는 `세션 만료` 메시지

**해결 방법**:
1. `.env` 파일의 PUBL_ID, PUBL_PW가 정확한지 확인
2. publ.biz 웹사이트에서 직접 로그인 가능한지 확인
3. `.session.json` 파일을 `.trash/` 폴더로 이동 후 재실행

### 6.2 "Airtable API 오류"

**증상**: `AIRTABLE_API_KEY` 또는 `인증 오류` 메시지

**해결 방법**:
1. `.env` 파일의 AIRTABLE_API_KEY가 유효한지 확인
2. Airtable 계정 설정에서 API 키 상태 확인
3. API 키가 해당 Base에 접근 권한이 있는지 확인

### 6.3 데이터가 중복 추가된 것 같을 때

**확인 방법**:
1. Airtable에서 Members 테이블 열기
2. Member Code 필드로 정렬
3. 같은 코드가 2개 이상 있는지 확인

**원인**:
- 수동으로 레코드를 추가한 경우
- 동기화 도중 오류 발생

**해결 방법**:
- 중복 레코드 중 나중에 생긴 것을 삭제

### 6.4 "Refund Status 옵션 누락" 경고

**증상**: `INVALID_MULTIPLE_CHOICE_OPTIONS` 메시지

**해결 방법**:
1. Airtable에서 Refunds 테이블 열기
2. Refund Status 필드 클릭
3. "Customize field type" 선택
4. 경고에 나온 새 옵션(예: "환불완료") 추가

---

## 7. 자주 하는 작업

### 7.1 새 구독 상품 추가 시

publ.biz에서 새 구독 상품을 만든 후:

1. 동기화 실행 (`run.command` 더블클릭)
2. Airtable Products 테이블 확인
3. 새 상품이 추가되었는지 확인
4. **수동 입력**:
   - `Subscription Days`: 구독 기간 (예: 30, 365)
   - `Display Name`: 표시용 이름

### 7.2 회원 안내 발송 후 체크하기

1. Airtable MemberProducts 테이블 열기
2. 안내를 보낸 회원의 레코드 찾기
3. `Welcome Sent` 체크박스에 체크

### 7.3 로그 파일 확인하기

**위치**: `logs/sync_YYYYMMDD.log`

**내용 예시**:
```
2026-01-08 10:30:00 [INFO] PUBL DATA MANAGER
2026-01-08 10:30:01 [INFO] 로그인 완료!
2026-01-08 10:30:15 [INFO] 회원 동기화: 5개 신규
2026-01-08 10:30:45 [INFO] 완료 시간: 2026-01-08 10:30:45
```

---

## 8. 설정 변경하기

설정은 두 곳에서 관리됩니다:

| 파일 | 내용 | 변경 빈도 |
|------|------|----------|
| `.env` | 비밀번호, API 키 | 거의 안 함 |
| `settings.yaml` | 동작 설정 | 필요시 |

### settings.yaml 예시

```yaml
# 브라우저 설정
browser:
  headless: true      # true: 창 숨김, false: 창 보임

# 동기화 설정
sync:
  batch_size: 100     # 한 번에 처리할 수
  timezone: "+09:00"  # 한국 시간
```

**주의**: YAML 파일은 들여쓰기가 중요합니다. 공백 개수를 그대로 유지하세요.

---

## 9. 긴급 상황 대처

### 자동화가 완전히 안 될 때

1. 터미널에서 오류 메시지 캡처 (스크린샷)
2. `logs/` 폴더의 최신 로그 파일 확인
3. 개발자에게 오류 메시지와 로그 파일 전달

### 데이터가 이상할 때

1. Airtable에서 변경하지 말고 현재 상태 스크린샷
2. `archive/` 폴더에서 해당 날짜의 CSV 파일 확인
3. CSV와 Airtable 비교하여 차이점 파악

---

## 부록: 용어 설명

| 용어 | 설명 |
|------|------|
| CSV | 엑셀처럼 표 형식의 데이터 파일 |
| API 키 | 프로그램이 서비스에 접근하기 위한 비밀번호 |
| Linked Record | Airtable에서 테이블 간 연결된 레코드 |
| 동기화 | 두 곳의 데이터를 일치시키는 작업 |
| 로그 | 프로그램 실행 기록 |
