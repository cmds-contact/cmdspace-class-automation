# 데이터 동기화 실패 - 세션 만료 오류 수정

**날짜**: 2025-12-18
**작업자**: Claude AI
**상태**: 해결 완료

---

## 1. 문제 현상

데이터 동기화 버튼 클릭 시 동기화가 실패함.

### 증상
- 대시보드에서 "데이터 동기화" 버튼 클릭
- 동기화 로그에 `failed` 상태로 기록됨
- 에러 메시지:
  - `회원 CSV 파일을 찾을 수 없습니다.`
  - `주문 CSV 파일을 찾을 수 없습니다.`
  - `환불 CSV 파일을 찾을 수 없습니다.`

### SyncLog 기록
```json
{
  "sync_type": "members",
  "status": "failed",
  "error_message": "회원 CSV 파일을 찾을 수 없습니다."
}
```

---

## 2. 원인 분석

### 근본 원인
Python 다운로드 스크립트가 publ.biz 웹사이트에서 데이터를 다운로드하지 못함.

### 세부 원인

1. **세션 파일 만료**
   - 마지막 세션 저장: 2025-12-16
   - 2일 경과 후 세션 쿠키 만료

2. **불충분한 세션 유효성 검사**
   - 기존 `is_session_valid` 함수는 단순히 `all-channels` 페이지에서 로그인 페이지로 리다이렉트되는지만 확인
   - 실제 members 페이지에 접근할 수 있는지는 검증하지 않음
   - 세션이 부분적으로 유효하여 검증은 통과하지만, 실제 데이터 페이지에서는 권한이 없어 다운로드 버튼이 표시되지 않음

3. **Playwright 타임아웃**
   - 다운로드 버튼을 30초 동안 찾지 못해 타임아웃 발생
   ```
   Locator.wait_for: Timeout 30000ms exceeded.
   waiting for get_by_role("button", name="All Member download(CSV)") to be visible
   ```

### 흐름도
```
세션 만료 → is_session_valid 통과 (버그) → members 페이지 접근
→ 권한 없음 → 다운로드 버튼 미표시 → 타임아웃 → CSV 다운로드 실패
→ DataSyncer에서 파일 없음 오류 → 동기화 실패
```

---

## 3. 해결 방법

### 3.1 세션 유효성 검사 강화 (장기 해결책)

**파일**: `python/src/downloader.py`

**변경 전**:
```python
def is_session_valid(context):
    page = context.new_page()
    page.goto('https://console.publ.biz/all-channels')
    page.wait_for_timeout(2000)
    if 'type=enter' in page.url:
        return False
    return True
```

**변경 후**:
```python
def is_session_valid(context):
    """저장된 세션이 유효한지 확인

    개선: all-channels 페이지 뿐만 아니라 실제 members 페이지에서
    다운로드 버튼이 표시되는지까지 확인합니다.
    """
    page = context.new_page()

    # 1차 검증: 채널 페이지 접근 가능 여부
    page.goto('https://console.publ.biz/all-channels')
    page.wait_for_timeout(2000)
    if 'type=enter' in page.url:
        print("   세션 만료: 로그인 페이지로 리다이렉트됨")
        return False

    # 2차 검증: members 페이지에서 다운로드 버튼 확인
    page.goto(config.PUBL_MEMBERS_URL)
    page.wait_for_timeout(3000)

    if 'type=enter' in page.url:
        print("   세션 만료: 회원 페이지 접근 시 로그인 필요")
        return False

    # 다운로드 버튼이 있는지 확인 (5초 대기)
    download_btn = page.get_by_role("button", name="All Member download(CSV)")
    try:
        download_btn.wait_for(state="visible", timeout=5000)
        return True
    except Exception:
        print("   세션 만료: 다운로드 버튼을 찾을 수 없음")
        return False
```

### 3.2 세션 디렉토리 자동 생성 추가

**파일**: `python/src/config.py`

```python
def ensure_directories():
    """필요한 디렉토리 생성"""
    DOWNLOAD_DIR.mkdir(parents=True, exist_ok=True)
    ARCHIVE_DIR.mkdir(parents=True, exist_ok=True)
    SESSION_FILE.parent.mkdir(parents=True, exist_ok=True)  # 추가
```

### 3.3 만료된 세션 파일 정리 (단기 해결책)

```bash
mv storage/sessions/.session.json .trash/
```

---

## 4. 수정 결과

### 테스트 결과
```
============================================================
PUBL DATA DOWNLOADER
시작 시간: 2025-12-18 16:48:57
============================================================
로그인 완료! (세션 저장됨)
저장 완료: 251218_164857_members.csv
저장 완료: 251218_164857_orders_latest.csv
저장 완료: 251218_164857_refunds.csv
============================================================
```

### DB 동기화 결과
```json
{
  "members": {"new": 7},
  "orders": {"new": 16},
  "refunds": {"new": 0, "updated": 0}
}
```

---

## 5. 앞으로 주의할 점

### 5.1 세션 관리
- publ.biz 세션은 약 2-3일 후 만료될 수 있음
- 정기적인 동기화(매일)를 수행하면 세션이 갱신되어 문제 없음
- 오랜 기간 동기화하지 않으면 세션이 만료될 수 있음

### 5.2 오류 발생 시 확인 사항
1. `storage/downloads/` 폴더에 CSV 파일이 있는지 확인
2. SyncLog 테이블에서 에러 메시지 확인
3. Python 스크립트 직접 실행하여 다운로드 테스트:
   ```bash
   cd python
   source .venv/bin/activate
   python -m src.main
   ```

### 5.3 세션 문제 발생 시 해결 방법
1. 세션 파일 삭제 (또는 .trash로 이동):
   ```bash
   mv storage/sessions/.session.json .trash/
   ```
2. 다시 동기화 실행 - 자동으로 새 로그인 수행

### 5.4 모니터링 권장
- SyncLog 테이블의 `status` 필드 정기 확인
- `failed` 상태가 연속으로 발생하면 세션 문제 의심

---

## 6. 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `python/src/downloader.py` | `is_session_valid` 함수 강화 - 다운로드 버튼까지 확인 |
| `python/src/config.py` | `ensure_directories`에 sessions 폴더 생성 추가 |

---

## 7. 관련 파일 참조

- 동기화 Job: `app/jobs/sync_data_job.rb`
- 데이터 동기화: `app/services/data_syncer.rb`
- Python 다운로더: `python/src/downloader.py`
- 설정: `python/src/config.py`
