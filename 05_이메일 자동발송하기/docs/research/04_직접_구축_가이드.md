# Python 이메일 직접 구축 가이드

> smtplib, Gmail SMTP, 네이버 SMTP를 활용한 이메일 자동화 구현

---

## 1. Python smtplib 기본

### 개요

`smtplib`은 Python 내장 라이브러리로, SMTP(Simple Mail Transfer Protocol)를 사용하여 이메일을 발송합니다.

### 기본 구조

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# SMTP 서버 연결
with smtplib.SMTP_SSL('smtp.example.com', 465) as server:
	server.login('username', 'password')
	server.send_message(message)
```

---

## 2. Gmail SMTP 설정

### 사전 요구사항

1. **Google 계정 2단계 인증 활성화**
2. **앱 비밀번호 생성** (일반 비밀번호 사용 불가)

> ⚠️ **2024년 9월 30일 이후**: Google Workspace 사용 시 향상된 보안(OAuth2.0) 필수

### 앱 비밀번호 생성 방법

1. [Google 계정 보안](https://myaccount.google.com/security) 접속
2. "2단계 인증" 활성화 확인
3. "앱 비밀번호" 선택
4. "메일" + "기기 선택" 후 생성
5. 16자리 비밀번호 복사

### Gmail SMTP 정보

| 항목 | 값 |
|------|---|
| SMTP 서버 | `smtp.gmail.com` |
| 포트 (SSL) | `465` |
| 포트 (TLS) | `587` |
| 일일 한도 | **500건** (무료) / 2,000건 (Workspace) |

### 기본 코드 (텍스트 이메일)

```python
import smtplib
from email.mime.text import MIMEText

def send_email_gmail(to_email: str, subject: str, body: str):
	"""Gmail SMTP로 텍스트 이메일 발송"""

	# 환경변수에서 인증 정보 로드 (보안)
	import os
	gmail_user = os.environ.get('GMAIL_USER')
	gmail_app_password = os.environ.get('GMAIL_APP_PASSWORD')

	# 메시지 생성
	message = MIMEText(body, 'plain', 'utf-8')
	message['Subject'] = subject
	message['From'] = gmail_user
	message['To'] = to_email

	# 발송
	with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
		server.login(gmail_user, gmail_app_password)
		server.send_message(message)

	print(f'이메일 발송 완료: {to_email}')
```

### HTML 이메일 발송

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os

def send_html_email_gmail(to_email: str, subject: str, html_content: str):
	"""Gmail SMTP로 HTML 이메일 발송"""

	gmail_user = os.environ.get('GMAIL_USER')
	gmail_app_password = os.environ.get('GMAIL_APP_PASSWORD')

	# Multipart 메시지 생성
	message = MIMEMultipart('alternative')
	message['Subject'] = subject
	message['From'] = gmail_user
	message['To'] = to_email

	# HTML 파트 추가
	html_part = MIMEText(html_content, 'html', 'utf-8')
	message.attach(html_part)

	# 발송
	with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
		server.login(gmail_user, gmail_app_password)
		server.send_message(message)

# 사용 예시
html = """
<html>
<body>
	<h1>결제 확인서</h1>
	<p>결제가 완료되었습니다.</p>
	<table>
		<tr><td>결제 금액</td><td>50,000원</td></tr>
		<tr><td>결제일</td><td>2024-11-27</td></tr>
	</table>
</body>
</html>
"""

send_html_email_gmail('customer@example.com', '결제 확인서', html)
```

---

## 3. 네이버 SMTP 설정

### 사전 요구사항

1. 네이버 메일 → 환경설정 → POP3/SMTP 설정
2. **POP3/SMTP 사용** 체크
3. **SMTP 인증 방식**: SSL 사용

### 네이버 SMTP 정보

| 항목 | 값 |
|------|---|
| SMTP 서버 | `smtp.naver.com` |
| 포트 (SSL) | `465` |
| 일일 한도 | **500건** |

### 네이버 SMTP 코드

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import os

def send_email_naver(to_email: str, subject: str, body: str, is_html: bool = False):
	"""네이버 SMTP로 이메일 발송"""

	naver_user = os.environ.get('NAVER_USER')  # example@naver.com
	naver_password = os.environ.get('NAVER_PASSWORD')

	if is_html:
		message = MIMEMultipart('alternative')
		message.attach(MIMEText(body, 'html', 'utf-8'))
	else:
		message = MIMEText(body, 'plain', 'utf-8')

	message['Subject'] = subject
	message['From'] = naver_user
	message['To'] = to_email

	with smtplib.SMTP_SSL('smtp.naver.com', 465) as server:
		server.login(naver_user, naver_password)
		server.send_message(message)

	print(f'이메일 발송 완료: {to_email}')
```

---

## 4. 보안 모범 사례

### 4.1 비밀번호 관리

> **절대 코드에 비밀번호 하드코딩 금지!**

**환경변수 사용**:
```bash
# .env 파일 (git에 포함하지 않음)
GMAIL_USER=your_email@gmail.com
GMAIL_APP_PASSWORD=xxxx xxxx xxxx xxxx
```

```python
# Python에서 로드
import os
from dotenv import load_dotenv

load_dotenv()
gmail_user = os.environ.get('GMAIL_USER')
```

**AWS Secrets Manager 사용** (프로덕션):
```python
import boto3
import json

def get_secret():
	client = boto3.client('secretsmanager')
	response = client.get_secret_value(SecretId='email-credentials')
	return json.loads(response['SecretString'])
```

### 4.2 TLS/SSL 사용

```python
# SSL (포트 465) - 권장
with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
	server.login(user, password)
	server.send_message(message)

# TLS (포트 587)
with smtplib.SMTP('smtp.gmail.com', 587) as server:
	server.starttls()  # TLS 시작
	server.login(user, password)
	server.send_message(message)
```

### 4.3 OAuth 2.0 (Gmail 권장)

```python
# google-auth 라이브러리 필요
# pip install google-auth google-auth-oauthlib google-auth-httplib2

from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow

SCOPES = ['https://www.googleapis.com/auth/gmail.send']

def get_gmail_credentials():
	flow = InstalledAppFlow.from_client_secrets_file(
		'client_secret.json', SCOPES
	)
	creds = flow.run_local_server(port=0)
	return creds
```

---

## 5. 에러 핸들링

### 기본 에러 처리

```python
import smtplib
from smtplib import SMTPException, SMTPAuthenticationError, SMTPRecipientsRefused

def send_email_safe(to_email: str, subject: str, body: str):
	"""에러 핸들링이 포함된 이메일 발송"""

	try:
		with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
			server.login(gmail_user, gmail_app_password)
			server.send_message(message)
		return True, "발송 성공"

	except SMTPAuthenticationError:
		return False, "인증 실패: 앱 비밀번호를 확인하세요"

	except SMTPRecipientsRefused as e:
		return False, f"수신자 거부: {e.recipients}"

	except SMTPException as e:
		return False, f"SMTP 에러: {str(e)}"

	except Exception as e:
		return False, f"알 수 없는 에러: {str(e)}"
```

### 대량 발송 에러 처리

```python
def send_bulk_emails(recipients: list, subject: str, body: str):
	"""대량 이메일 발송 (에러 건너뛰기)"""

	results = {'success': [], 'failed': []}

	with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
		server.login(gmail_user, gmail_app_password)

		for recipient in recipients:
			try:
				message = create_message(recipient, subject, body)
				server.send_message(message)
				results['success'].append(recipient)
			except Exception as e:
				results['failed'].append({
					'email': recipient,
					'error': str(e)
				})

	return results
```

---

## 6. 첨부파일 발송

### 파일 첨부

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email import encoders
import os

def send_email_with_attachment(
	to_email: str,
	subject: str,
	body: str,
	attachment_path: str
):
	"""첨부파일 포함 이메일 발송"""

	gmail_user = os.environ.get('GMAIL_USER')
	gmail_app_password = os.environ.get('GMAIL_APP_PASSWORD')

	# Multipart 메시지 생성
	message = MIMEMultipart()
	message['Subject'] = subject
	message['From'] = gmail_user
	message['To'] = to_email

	# 본문 추가
	message.attach(MIMEText(body, 'plain', 'utf-8'))

	# 첨부파일 추가
	filename = os.path.basename(attachment_path)
	with open(attachment_path, 'rb') as f:
		part = MIMEBase('application', 'octet-stream')
		part.set_payload(f.read())

	encoders.encode_base64(part)
	part.add_header(
		'Content-Disposition',
		f'attachment; filename="{filename}"'
	)
	message.attach(part)

	# 발송
	with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
		server.login(gmail_user, gmail_app_password)
		server.send_message(message)

# 사용 예시
send_email_with_attachment(
	'customer@example.com',
	'결제 영수증',
	'첨부된 영수증을 확인해 주세요.',
	'/path/to/receipt.pdf'
)
```

---

## 7. 이메일 템플릿 시스템

### Jinja2 템플릿 사용

```python
# pip install jinja2

from jinja2 import Environment, FileSystemLoader

def render_email_template(template_name: str, context: dict) -> str:
	"""Jinja2 템플릿으로 이메일 렌더링"""

	env = Environment(loader=FileSystemLoader('templates'))
	template = env.get_template(template_name)
	return template.render(**context)

# templates/payment_confirmation.html
"""
<!DOCTYPE html>
<html>
<body>
	<h1>결제 확인서</h1>
	<p>안녕하세요, {{ customer_name }}님!</p>
	<p>결제가 완료되었습니다.</p>

	<table>
		<tr><td>주문번호</td><td>{{ order_id }}</td></tr>
		<tr><td>결제금액</td><td>{{ amount | format_currency }}</td></tr>
		<tr><td>결제일시</td><td>{{ payment_date }}</td></tr>
	</table>

	<a href="{{ receipt_url }}">영수증 확인</a>
</body>
</html>
"""

# 사용
html = render_email_template('payment_confirmation.html', {
	'customer_name': '홍길동',
	'order_id': 'ORD-2024-001',
	'amount': 50000,
	'payment_date': '2024-11-27 14:30',
	'receipt_url': 'https://example.com/receipt/123'
})
```

---

## 8. 완전한 예제: 결제 확인 이메일 시스템

### 프로젝트 구조

```
email_automation/
├── .env                    # 환경변수 (git 무시)
├── .gitignore
├── requirements.txt
├── config.py               # 설정
├── email_service.py        # 이메일 서비스
├── templates/
│   ├── payment_confirmation.html
│   └── welcome.html
└── main.py                 # 실행
```

### requirements.txt

```
python-dotenv==1.0.0
jinja2==3.1.2
```

### config.py

```python
import os
from dotenv import load_dotenv

load_dotenv()

class Config:
	SMTP_SERVER = os.environ.get('SMTP_SERVER', 'smtp.gmail.com')
	SMTP_PORT = int(os.environ.get('SMTP_PORT', 465))
	SMTP_USER = os.environ.get('SMTP_USER')
	SMTP_PASSWORD = os.environ.get('SMTP_PASSWORD')
	SENDER_NAME = os.environ.get('SENDER_NAME', 'My Service')
```

### email_service.py

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
from jinja2 import Environment, FileSystemLoader
from config import Config

class EmailService:
	def __init__(self):
		self.config = Config
		self.template_env = Environment(
			loader=FileSystemLoader('templates')
		)

	def _create_message(
		self,
		to_email: str,
		subject: str,
		html_content: str
	) -> MIMEMultipart:
		"""이메일 메시지 생성"""

		message = MIMEMultipart('alternative')
		message['Subject'] = Header(subject, 'utf-8')
		message['From'] = f"{self.config.SENDER_NAME} <{self.config.SMTP_USER}>"
		message['To'] = to_email

		html_part = MIMEText(html_content, 'html', 'utf-8')
		message.attach(html_part)

		return message

	def _render_template(self, template_name: str, context: dict) -> str:
		"""템플릿 렌더링"""
		template = self.template_env.get_template(template_name)
		return template.render(**context)

	def send_email(
		self,
		to_email: str,
		subject: str,
		template_name: str,
		context: dict
	) -> bool:
		"""이메일 발송"""

		try:
			html_content = self._render_template(template_name, context)
			message = self._create_message(to_email, subject, html_content)

			with smtplib.SMTP_SSL(
				self.config.SMTP_SERVER,
				self.config.SMTP_PORT
			) as server:
				server.login(
					self.config.SMTP_USER,
					self.config.SMTP_PASSWORD
				)
				server.send_message(message)

			return True

		except Exception as e:
			print(f"이메일 발송 실패: {e}")
			return False

	def send_payment_confirmation(
		self,
		to_email: str,
		customer_name: str,
		order_id: str,
		amount: int,
		payment_date: str
	) -> bool:
		"""결제 확인 이메일 발송"""

		return self.send_email(
			to_email=to_email,
			subject=f'[결제완료] 주문번호 {order_id}',
			template_name='payment_confirmation.html',
			context={
				'customer_name': customer_name,
				'order_id': order_id,
				'amount': f'{amount:,}원',
				'payment_date': payment_date
			}
		)
```

### main.py

```python
from email_service import EmailService

def main():
	service = EmailService()

	# 결제 확인 이메일 발송
	success = service.send_payment_confirmation(
		to_email='customer@example.com',
		customer_name='홍길동',
		order_id='ORD-2024-001',
		amount=50000,
		payment_date='2024-11-27 14:30'
	)

	if success:
		print('결제 확인 이메일이 발송되었습니다.')
	else:
		print('이메일 발송에 실패했습니다.')

if __name__ == '__main__':
	main()
```

---

## 9. 한계 및 대안

### SMTP 직접 발송의 한계

| 한계 | 설명 |
|------|------|
| **발송 한도** | Gmail/네이버 일 500건 제한 |
| **전달률 문제** | 자체 도메인 미사용 시 스팸 위험 |
| **통계 없음** | 오픈율, 클릭률 추적 불가 |
| **반송 처리 어려움** | 수동 관리 필요 |
| **확장성** | 대량 발송 부적합 |

### 대안 추천

| 상황 | 추천 |
|------|------|
| 월 500건 미만 | Gmail/네이버 SMTP |
| 월 500~10,000건 | **API 서비스 (AWS SES, Resend)** |
| 월 10,000건 이상 | **AWS SES + 전용 인프라** |
| 마케팅 이메일 | **스티비 또는 Mailchimp** |

---

## 참고 링크

- [Python smtplib 공식 문서](https://docs.python.org/3/library/smtplib.html)
- [Real Python - Sending Emails With Python](https://realpython.com/python-send-email/)
- [Mailtrap - Python Send Email Tutorial](https://mailtrap.io/blog/python-send-email/)
- [Gmail SMTP 설정 가이드](https://support.google.com/a/answer/176600)
- [네이버 SMTP 설정](https://help.naver.com/service/5632/category/16848)
